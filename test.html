<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Snake — Final Build (Normal / Competitive / Dungeon Adventure)</title>
<style>
:root{--bg:#060608;--panel:#0f1113;--muted:#9aa0a6;--accent:#2b6fd6}
html,body{height:100%;margin:0;background:var(--bg);color:#eef;font-family:Inter,Arial,Helvetica,sans-serif}
#app{display:flex;height:100vh}
#sidebar{width:320px;background:var(--panel);padding:18px;box-sizing:border-box;border-right:2px solid #111;overflow:auto}
#main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center}
canvas{background:#000;border:2px solid #222}
h1{margin:8px 0}
.btn{display:block;width:100%;padding:10px;border-radius:8px;border:none;background:var(--accent);color:white;margin:8px 0;cursor:pointer;font-weight:600}
.small{padding:8px;font-size:13px}
.row{display:flex;gap:8px}
.info{color:var(--muted);font-size:13px}
.skin-button{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:6px 0;border-radius:8px;background:#111;border:1px solid #222}
.perk{display:flex;justify-content:space-between;padding:8px;margin:6px 0;border-radius:8px;background:#0b0c0d;border:1px solid #222}
.switch{display:inline-flex;align-items:center;gap:8px}
.badge{background:#222;padding:4px 8px;border-radius:999px}
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h1>Snake — Final Build</h1>
    <div class="info">Modes & Start Screen</div>
    <button class="btn" id="startNormal">Start: Normal</button>
    <button class="btn" id="startCompetitive">Start: Competitive</button>
    <button class="btn" id="startAdventure">Start: Dungeon Adventure</button>
    <div style="height:12px"></div>
    <button class="btn small" id="openShop">Open Shop</button>
    <button class="btn small" id="openMastery">Open Mastery</button>
    <div style="height:12px"></div>
    <h3>Settings</h3>
    <div class="row">
      <div class="switch"><label>Sound</label><input type="checkbox" id="soundToggle" checked></div>
    </div>
    <div style="height:8px"></div>
    <h3>Stats</h3>
    <div class="info">Score: <span id="uiScore">0</span></div>
    <div class="info">Coins: <span id="uiCoins">0</span></div>
    <div class="info">Gold Apples: <span id="uiGold">0</span></div>

    <h3 style="margin-top:12px">Skins</h3>
    <div id="shopList"></div>

    <h3 style="margin-top:12px">Mastery</h3>
    <div id="masteryList"></div>

    <div style="height:18px"></div>
    <button class="btn small" id="resetAll">Reset Progress</button>
  </div>

  <div id="main">
    <div id="startScreen" style="text-align:center;max-width:700px">
      <h2>Welcome — Pick a Mode</h2>
      <div class="info">Use arrow keys to move. Press S to open Shop, M for Mastery during pause.</div>
    </div>

    <canvas id="game" width="400" height="400" tabindex="0" style="margin-top:18px"></canvas>
    <div id="hud" style="margin-top:12px;display:flex;gap:18px;align-items:center">
      <div id="modeLabel" class="info"></div>
      <div id="statusMsg" class="info"></div>
    </div>
  </div>
</div>

<script>
// ------------------ Constants & Storage Keys ------------------
const LS = { coins: 'snake_coins_v1', unlocked: 'snake_unlocked_v1', skin: 'snake_skin_v1', mastery: 'snake_mastery_v1' };

// ------------------ Canvas ------------------
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const grid = 16; const size = 25; // 400/16

// ------------------ UI Elements ------------------
const uiScore = document.getElementById('uiScore');
const uiCoins = document.getElementById('uiCoins');
const uiGold = document.getElementById('uiGold');
const modeLabel = document.getElementById('modeLabel');
const statusMsg = document.getElementById('statusMsg');
const startNormal = document.getElementById('startNormal');
const startCompetitive = document.getElementById('startCompetitive');
const startAdventure = document.getElementById('startAdventure');
const openShop = document.getElementById('openShop');
const openMastery = document.getElementById('openMastery');
const shopList = document.getElementById('shopList');
const masteryList = document.getElementById('masteryList');
const resetAll = document.getElementById('resetAll');
const soundToggle = document.getElementById('soundToggle');

// ------------------ Game State ------------------
let mode = null; // 'normal' | 'competitive' | 'adventure'
let difficulty = 'normal';
let speedFrames = 8;
let frameCounter = 0;
let paused = true;
let score = 0; let coins = parseInt(localStorage.getItem(LS.coins)) || 0; let goldCount = 0;
let unlocked = JSON.parse(localStorage.getItem(LS.unlocked) || JSON.stringify(['green']));
let selectedSkin = localStorage.getItem(LS.skin) || 'green';
let mastery = JSON.parse(localStorage.getItem(LS.mastery) || JSON.stringify({points:0,perks:{}}));

// ------------------ Skins ------------------
const skins = {
  green:{name:'Verdant',cost:0,draw:(x,y)=>{ctx.fillStyle='lime';ctx.fillRect(x,y,grid-1,grid-1)}},
  blue:{name:'Cerulean',cost:20,draw:(x,y)=>{let g=ctx.createLinearGradient(x,y,x+grid,y+grid);g.addColorStop(0,'#005fda');g.addColorStop(1,'#00e5ff');ctx.fillStyle=g;ctx.fillRect(x,y,grid-1,grid-1)}},
  red:{name:'Crimson',cost:20,draw:(x,y)=>{let g=ctx.createLinearGradient(x,y,x+grid,y);g.addColorStop(0,'#ff0044');g.addColorStop(1,'#ff9aa2');ctx.fillStyle=g;ctx.fillRect(x,y,grid-1,grid-1)}},
  neon:{name:'Neon Glow',cost:50,draw:(x,y)=>{let g=ctx.createLinearGradient(x,y,x,y+grid);g.addColorStop(0,'#39ff14');g.addColorStop(1,'#00ffd5');ctx.fillStyle=g;ctx.fillRect(x,y,grid-1,grid-1)}},
  rainbow:{name:'Rainbow',cost:80,draw:(x,y,i)=>{ctx.fillStyle=`hsl(${(i*25)%360},90%,60%)`;ctx.fillRect(x,y,grid-1,grid-1)}},
  pixel:{name:'Pixel',cost:60,draw:(x,y)=>{ctx.fillStyle='#c19d6a';ctx.fillRect(x,y,grid/2,grid/2);ctx.fillRect(x+grid/2,y+grid/2,grid/2,grid/2)}},
  metal:{name:'Metal',cost:70,draw:(x,y)=>{let g=ctx.createLinearGradient(x,y,x+grid,y);g.addColorStop(0,'#bbb');g.addColorStop(1,'#666');ctx.fillStyle=g;ctx.fillRect(x,y,grid-1,grid-1)}},
};

// ------------------ Mastery Perks ------------------
const masteryPerks = {
  startBigger:{name:'Start Bigger',cost:2,desc:'Start each level with +4 length',apply:run=>run.player.maxCells+=4},
  doublePoints:{name:'Double Points',cost:3,desc:'Apples give 2x points',apply:()=>{}},
  extraCoins:{name:'Treasure Hunter',cost:2,desc:'Each apple gives +1 coin',apply:()=>{}},
  shield:{name:'Shield',cost:4,desc:'One collision ignored per level',apply:run=>run.player.shield=true},
  fastLearner:{name:'Fast Learner',cost:3,desc:'Gain extra mastery from gold apples',apply:()=>{}},
  momentum:{name:'Momentum',cost:3,desc:'Slight speed increase as you grow',apply:()=>{}},
  lucky:{name:'Lucky Finder',cost:4,desc:'Higher gold apple spawn chance',apply:()=>{}}
};

// ------------------ Game Run Object ------------------
function createRun(modeType){
  return {
    mode: modeType,
    player:{x:160,y:160,dx:grid,dy:0,cells:[],maxCells:4},
    bot: {x:240,y:240,dx:0,dy:grid,cells:[],maxCells:4},
    apple:{x:Math.floor(Math.random()*size)*grid,y:Math.floor(Math.random()*size)*grid},
    gold:null, powerups:[], enemies:[], keys:0, shieldUsed:false
  }
}
let run = null;

// ------------------ Audio (WebAudio) ------------------
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
function playTone(freq, type='sine', dur=0.06, vol=0.08){ if(!soundToggle.checked) return; try{ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur);}catch(e){} }
function sfxPickup(){ playTone(880,'sine',0.06,0.06); }
function sfxGold(){ playTone(1320,'square',0.14,0.12); }
function sfxHit(){ playTone(140,'sawtooth',0.12,0.12); }

// ------------------ Helpers ------------------
function persist(){ localStorage.setItem(LS.coins, coins); localStorage.setItem(LS.unlocked, JSON.stringify(unlocked)); localStorage.setItem(LS.skin, selectedSkin); localStorage.setItem(LS.mastery, JSON.stringify(mastery)); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function wrapPos(s){ if(s.x<0) s.x=(size-1)*grid; if(s.x>(size-1)*grid) s.x=0; if(s.y<0) s.y=(size-1)*grid; if(s.y>(size-1)*grid) s.y=0; }
function randomCell(){ return {x:Math.floor(Math.random()*size)*grid,y:Math.floor(Math.random()*size)*grid}; }

// ------------------ Shop & Mastery UI ------------------
function refreshShop(){ shopList.innerHTML=''; for(const id in skins){ const sk=skins[id]; const div=document.createElement('div'); div.className='skin-button'; div.innerHTML = `<div><strong>${sk.name}</strong><div class='info'>Cost: ${sk.cost}</div></div><div></div>`; const btn=document.createElement('button'); btn.textContent = unlocked.includes(id)? (selectedSkin===id? 'Equipped':'Equip') : 'Buy'; btn.onclick = ()=>{ if(unlocked.includes(id)){ selectedSkin=id; localStorage.setItem(LS.skin,selectedSkin); refreshShop(); } else if(coins>=sk.cost){ coins-=sk.cost; unlocked.push(id); selectedSkin=id; persist(); refreshShop(); sfxPickup(); } else alert('Not enough coins'); updateUI(); }; div.querySelector('div:last-child').appendChild(btn); shopList.appendChild(div);} updateUI(); }

function refreshMastery(){ masteryList.innerHTML=''; const mpHeader = document.createElement('div'); mpHeader.className='info'; mpHeader.textContent = `Points: ${mastery.points}`; masteryList.appendChild(mpHeader); for(const id in masteryPerks){ const p=masteryPerks[id]; const div=document.createElement('div'); div.className='perk'; div.innerHTML = `<div><strong>${p.name}</strong><div class='info'>${p.desc}</div></div>`; const btn=document.createElement('button'); btn.textContent = 'Buy'; btn.className='small'; btn.onclick=()=>{ if(mastery.points>=p.cost && !mastery.perks[id]){ mastery.points-=p.cost; mastery.perks[id]=true; persist(); refreshMastery(); alert('Perk unlocked'); } else alert('Cannot buy perk'); }; div.appendChild(btn); masteryList.appendChild(div); } }

// ------------------ Game Logic ------------------
function start(modeType){ mode = modeType; run = createRun(modeType); paused=false; frameCounter=0; score=0; modeLabel.textContent = modeType.toUpperCase(); statusMsg.textContent=''; applyMasteryInit(); updateUI(); }

function applyMasteryInit(){ // apply perks that affect start
  run.player.maxCells = 4; if(mastery.perks.startBigger) run.player.maxCells += 4; if(mastery.perks.shield) run.player.shield = true; else run.player.shield = false; }

function resetProgress(){ if(confirm('Reset all progress?')){ coins=0; unlocked=['green']; selectedSkin='green'; mastery={points:0,perks:{}}; persist(); refreshShop(); refreshMastery(); updateUI(); }}

// Movement controls
document.addEventListener('keydown',e=>{
  if(!run) return;
  if(e.key==='ArrowLeft' && run.player.dx===0){ run.player.dx = -grid; run.player.dy = 0; }
  if(e.key==='ArrowRight' && run.player.dx===0){ run.player.dx = grid; run.player.dy = 0; }
  if(e.key==='ArrowUp' && run.player.dy===0){ run.player.dy = -grid; run.player.dx = 0; }
  if(e.key==='ArrowDown' && run.player.dy===0){ run.player.dy = grid; run.player.dx = 0; }
  if(e.key.toLowerCase()==='s'){ alert('Shop opened on the left.'); }
  if(e.key.toLowerCase()==='m'){ alert('Mastery panel on the left.'); }
});

// Start buttons
startNormal.onclick = ()=>{ setDifficulty('normal'); start('normal'); };
startCompetitive.onclick = ()=>{ setDifficulty('normal'); start('competitive'); };
startAdventure.onclick = ()=>{ setDifficulty('normal'); start('adventure'); initDungeon(); };
openShop.onclick = ()=>{ alert('Shop is on the left.'); };
openMastery.onclick = ()=>{ alert('Mastery is on the left.'); };
resetAll.onclick = resetProgress;

function setDifficulty(d){ difficulty=d; if(d==='easy') speedFrames=12; if(d==='normal') speedFrames=8; if(d==='hard') speedFrames=5; if(d==='insane') speedFrames=3; }

// ------------------ Run Loop ------------------
function loop(){ requestAnimationFrame(loop); if(!run || paused) return; frameCounter++; if(frameCounter < speedFrames) return; frameCounter=0; updateRun(); renderRun(); }

function updateRun(){ // move player
  run.player.x += run.player.dx; run.player.y += run.player.dy; wrapPos(run.player);
  run.player.cells.unshift({x:run.player.x,y:run.player.y}); if(run.player.cells.length > run.player.maxCells) run.player.cells.pop();

  // apple pickup
  if(run.player.x===run.apple.x && run.player.y===run.apple.y){ let gain = mastery.perks.doublePoints?2:1; run.player.maxCells += gain; score += gain; let coinGain = gain + (mastery.perks.extraCoins?1:0); coins += coinGain; sfxPickup(); // chance gold apple
    if(Math.random() < (mastery.perks.lucky?0.08:0.04)) spawnGold(); placeApple(); persist(); updateUI(); }

  // gold apple
  if(run.gold){ run.gold.ttl--; if(run.player.x===run.gold.x && run.player.y===run.gold.y){ goldCount++; coins += 10; mastery.points += (mastery.perks.fastLearner?2:1); sfxGold(); run.gold = null; persist(); updateUI(); } else if(run.gold.ttl<=0) run.gold=null; }

  // competitive bot
  if(run.mode==='competitive'){ botAIStep(); run.bot.x += run.bot.dx; run.bot.y += run.bot.dy; wrapPos(run.bot); run.bot.cells.unshift({x:run.bot.x,y:run.bot.y}); if(run.bot.cells.length > run.bot.maxCells) run.bot.cells.pop(); if(run.bot.x===run.apple.x && run.bot.y===run.apple.y){ run.bot.maxCells++; placeApple(); } }

  // collisions: self
  if(selfCollision(run.player) && !run.player.shield){ gameOver('You collided with yourself'); }
  else if(selfCollision(run.player) && run.player.shield && !run.shieldUsed){ run.shieldUsed = true; sfxPickup(); }

  // p vs bot collisions
  if(run.mode==='competitive'){ if(run.player.cells.some(pc=>run.bot.cells.some(bc=>bc.x===pc.x && bc.y===pc.y))){ gameOver('Collision with bot'); } }

}

function gameOver(msg){ sfxHit(); statusMsg.textContent = msg; paused = true; setTimeout(()=>{ statusMsg.textContent=''; start(mode); },1200); }

function selfCollision(s){ for(let i=1;i<s.cells.length;i++) if(s.cells[0].x===s.cells[i].x && s.cells[0].y===s.cells[i].y) return true; return false; }

function placeApple(){ // place apple not on snake
  let tries=0; while(tries<500){ const pos = randomCell(); if(!run.player.cells.some(c=>c.x===pos.x&&c.y===pos.y) && !(run.mode==='competitive' && run.bot.cells.some(c=>c.x===pos.x&&c.y===pos.y))){ run.apple = pos; return; } tries++; } }

function spawnGold(){ run.gold = {x:Math.floor(Math.random()*size)*grid,y:Math.floor(Math.random()*size)*grid,ttl:900}; }

function botAIStep(){ // simple greedy bot using toroidal dist
  if(!run.bot) run.bot = {x:240,y:240,dx:0,dy:grid,cells:[],maxCells:4}; const dirs=[{dx: grid,dy:0},{dx:-grid,dy:0},{dx:0,dy:grid},{dx:0,dy:-grid}]; let best=null; let bestD=1e9; for(const d of dirs){ if(d.dx===-run.bot.dx && d.dy===-run.bot.dy) continue; let nx = run.bot.x + d.dx; let ny = run.bot.y + d.dy; if(nx<0) nx=(size-1)*grid; if(nx>(size-1)*grid) nx=0; if(ny<0) ny=(size-1)*grid; if(ny>(size-1)*grid) ny=0; // avoid self
    if(run.bot.cells.some(c=>c.x===nx&&c.y===ny)) continue; const dist = Math.abs(nx - run.apple.x) + Math.abs(ny - run.apple.y); if(dist < bestD){ bestD = dist; best = d; } }
  if(best){ run.bot.dx = best.dx; run.bot.dy = best.dy; }
}

function renderRun(){ ctx.clearRect(0,0,canvas.width,canvas.height);
  // apple
  ctx.fillStyle='red'; ctx.fillRect(run.apple.x,run.apple.y,grid-1,grid-1);
  // gold
  if(run.gold){ ctx.fillStyle='yellow'; ctx.fillRect(run.gold.x,run.gold.y,grid-1,grid-1); ctx.strokeStyle='gold'; ctx.strokeRect(run.gold.x+1,run.gold.y+1,grid-3,grid-3);} 
  // bot
  if(run.mode==='competitive'){ ctx.fillStyle='blue'; run.bot.cells.forEach(c=>ctx.fillRect(c.x,c.y,grid-1,grid-1)); ctx.fillStyle='white'; ctx.font='16px Arial'; ctx.fillText(`Bot: ${run.bot.maxCells-4}`,300,20);} 
  // player
  if(selectedSkin==='rainbow'){ run.player.cells.forEach((c,i)=>skins.rainbow.draw(c.x,c.y,i)); } else { run.player.cells.forEach(c=>skins[selectedSkin].draw(c.x,c.y)); }
  // score UI
  uiScore.textContent = score; uiCoins.textContent = coins; uiGold.textContent = goldCount;
}

// ------------------ Dungeon Adventure (simple rooms) ------------------
let dungeon = null; function initDungeon(){ dungeon = { cols:3, rows:3, rooms:[] }; for(let r=0;r<dungeon.rows;r++){ for(let c=0;c<dungeon.cols;c++){ const room = {walls:[], doors:[], enemies:[]}; // add some walls
    if(Math.random()<0.6){ for(let i=0;i<6;i++){ const wx=Math.floor(Math.random()*20)+2; const wy=Math.floor(Math.random()*20)+2; const ww=Math.floor(Math.random()*3)+1; const wh=Math.floor(Math.random()*3)+1; room.walls.push({x:wx,y:wy,w:ww,h:wh}); } }
    dungeon.rooms.push(room); } }
  // spawn player center
  run.player.x = Math.floor(size/2)*grid; run.player.y = Math.floor(size/2)*grid; placeApple(); }

function posBlocked(room,x,y){ for(const w of room.walls){ const rx=w.x*grid, ry=w.y*grid, rw=w.w*grid, rh=w.h*grid; if(x>=rx && x<rx+rw && y>=ry && y<ry+rh) return true; } return false; }

// ------------------ Initialization ------------------
refreshShop(); refreshMastery(); updateUI(); requestAnimationFrame(loop);

function updateUI(){ uiScore.textContent = score; uiCoins.textContent = coins; uiGold.textContent = goldCount; }

// persist periodically
setInterval(()=>{ persist(); },2000);

// expose reset
resetAll.onclick = resetProgress;

// final notes: start screen present; run created on button press

</script>
</body>
</html>
